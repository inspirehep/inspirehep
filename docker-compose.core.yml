# -*- coding: utf-8 -*-
#
# Copyright (C) 2019 CERN.
#
# inspirehep is free software; you can redistribute it and/or modify it under
# the terms of the MIT License; see LICENSE file for more details.

# Core for e2e and local development

version: '2.1'
services:
  cache:
    extends:
      file: docker-compose.services.yml
      service: cache
    ports:
     - "6379:6379"
  db:
    extends:
      file: docker-compose.services.yml
      service: db
    ports:
     - "5432:5432"
  mq:
    extends:
      file: docker-compose.services.yml
      service: mq
    ports:
     - "5672:5672"
  es:
    extends:
      file: docker-compose.services.yml
      service: es
    ports:
     - "9200:9200"
  flower:
    extends:
      file: docker-compose.services.yml
      service: flower
    ports:
     - "5555:5555"
  ui: # TODO: change the name since to app or lb since it's the main entry point for every request
    build:
      context: ui
      dockerfile: docker/Dockerfile-ui
    ports:
     - "8081:8081"
    volumes:
      - .:/opt/inspire/ui
    depends_on:
      - web
      - web-next
  web:
    extends:
      file: docker-compose.services.yml
      service: app
    ports:
     - "8000:8000"
    command: poetry run gunicorn --reload -b 0.0.0.0:8000  --access-logfile "-" --error-logfile - inspirehep.wsgi:application
  worker:
    extends:
      file: docker-compose.services.yml
      service: app
    command: poetry run watchmedo auto-restart -d . -p '*.py' -- celery worker -E -A inspirehep.celery -l INFO --purge --queues celery,migrator,indexer_task
    depends_on:
      - db
      - es
      - mq
      - cache
  web-next:
    extends:
      file: docker-compose.services.yml
      service: inspire-next
    command: gunicorn -b 0.0.0.0:5000 --access-logfile "-" --reload --log-level debug inspirehep.wsgi
    ports:
      - "5000:5000"
    depends_on:
      - worker-next
  worker-next:
    extends:
      file: docker-compose.services.yml
      service: inspire-next
    command: celery worker -E -A inspirehep.celery --loglevel=INFO --purge --queues celery,migrator,orcid_push,indexer_task
    healthcheck:
      timeout: 5s
      interval: 5s
      retries: 5
      test:
       - "CMD"
       - "bash"
       - "-c"
       - "/virtualenv/bin/celery --broker=pyamqp://guest:guest@rabbitmq:5672// inspect ping | grep OK"
    depends_on:
      - db
      - es
      - mq
      - cache
