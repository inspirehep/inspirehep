name: E2E tests

on:
  workflow_call:
    inputs:
      ref:
        description: The reference to test
        type: string
        required: true
      backend-image:
        description: The backend image
        type: string
        required: true
      editor-image:
        description: The editor image
        type: string
        required: true
      ui-image:
        description: The UI image
        type: string
        required: true

defaults:
  run:
    shell: bash

jobs:
  e2e:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [ chrome ]
        containers: [ 1 ]
    services:
      redis:
        image: redis
        ports:
          - 6379:6379

      postgresql:
        image: postgres:14.1
        env:
          POSTGRES_USER: inspirehep
          POSTGRES_PASSWORD: inspirehep
          POSTGRES_DB: inspirehep
        ports:
          - 5432:5432

      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672

      elasticsearch:
        image: registry.cern.ch/cern-sis/inspirehep/elasticsearch
        env:
          bootstrap.memory_lock: true
          ES_JAVA_OPTS: -Xms1024m -Xmx1024m
          discovery.type: single-node
        ports:
          - 9200:9200

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.ref }}

      - name: create environment file
        run: |
          cat <<EOF >env.list
          INVENIO_DEBUG=True
          INVENIO_MAIL_DEBUG=1
          INVENIO_ACCOUNTS_SESSION_REDIS_URL=redis://localhost:6379/2
          INVENIO_BROKER_URL=amqp://guest:guest@localhost:5672/
          INVENIO_CACHE_REDIS_URL=redis://localhost:6379/0
          INVENIO_CACHE_TYPE=redis
          INVENIO_CELERY_BROKER_URL=amqp://guest:guest@localhost:5672/
          INVENIO_CELERY_RESULT_BACKEND=redis://localhost:6379/1
          INVENIO_SEARCH_ELASTIC_HOSTS=[localhost]
          INVENIO_SECRET_KEY=CHANGE_ME
          INVENIO_SQLALCHEMY_DATABASE_URI=postgresql+psycopg2://inspirehep:inspirehep@localhost:5432/inspirehep
          INVENIO_INSPIRE_NEXT_URL=http://localhost:5000
          APP_DEBUG=True
          APP_MAIL_DEBUG=1
          APP_SQLALCHEMY_DATABASE_URI=postgresql+psycopg2://inspirehep:inspirehep@localhost:5432/inspirehep
          APP_CELERY_BROKER_URL=amqp://guest:guest@localhost:5672/
          APP_CELERY_RESULT_BACKEND=redis://localhost:6379/1
          APP_CACHE_REDIS_URL=redis://localhost:6379/0
          APP_ACCOUNTS_SESSION_REDIS_URL=redis://localhost:6379/2
          APP_SEARCH_ELASTIC_HOSTS=[localhost]
          APP_ES_BULK_TIMEOUT=240
          APP_DANGEROUSLY_ENABLE_LOCAL_LOGIN=True
          APP_ENABLE_SECURE_HEADERS=False
          APP_SECRET_KEY=CHANGE_ME
          EOF

      - name: Run hep-worker
        run: >
          docker run
          --detach
          --network host
          --env-file ./env.list
          --name hep-worker
          --entrypoint celery
          ${{ inputs.backend-image }}
          worker
          -E
          -A inspirehep.celery
          -l INFO
          --purge
          --queues celery,migrator,indexer_task,matcher,assign

      - name: Run hep-web
        run: >
          docker run
          --detach
          --network host
          --env-file ./env.list
          --name hep-web
          --entrypoint gunicorn
          ${{ inputs.backend-image }}
          -t 99999
          -b 0.0.0.0:8000
          --access-logfile "-"
          --error-logfile "-"
          inspirehep.wsgi:application

      - name: run next-worker
        run: >
          docker run
          --detach
          --network host
          --env-file ./env.list
          --name next-worker
          --entrypoint celery
          inspirehep/next:latest
          worker
          -E
          -A inspirehep.celery
          --loglevel=INFO
          --purge
          --queues celery,orcid_push,indexer_task

      - name: run next-web
        run: >
          docker run
          --detach
          --network host
          --env-file ./env.list
          --name next-web
          --entrypoint gunicorn
          inspirehep/next-assets:latest
          -b 0.0.0.0:5000
          --access-logfile "-"
          --log-level debug
          inspirehep.wsgi

      - name: run editor
        run: >
          docker run
          --detach
          --network host
          --name record-editor
          ${{ inputs.editor-image }}

      - name: run ui
        run: >
          docker run
          --detach
          --network host
          --name ui
          --add-host=hep-web:127.0.0.1
          --add-host=next-web:127.0.0.1
          --add-host=record-editor:127.0.0.1
          --mount type=bind,source=${{ github.workspace }}/ui/docker/nginx/config/local.conf,destination=/etc/nginx/conf.d/default.conf
          ${{ inputs.ui-image }}

      - name: setup
        run: |
          docker exec hep-web ./scripts/setup
          docker exec next-web inspirehep db create

      - name: import dataset
        run: >
          docker exec hep-web inspirehep importer records
          -f data/records/authors/1010819.json
          -f data/records/conferences/1769332.json
          -f data/records/conferences/1794610.json
          -f data/records/conferences/1809034.json
          -f data/records/conferences/1776122.json
          -f data/records/conferences/1622944.json
          -f data/records/seminars/1811573.json
          -f data/records/seminars/1811750.json
          -f data/records/seminars/1811657.json
          -f data/records/seminars/1807692.json
          -f data/records/seminars/1807690.json
          -f data/records/jobs/1811684.json
          -f data/records/jobs/1812904.json
          -f data/records/jobs/1813119.json
          -f data/records/jobs/1811836.json
          -f data/records/jobs/1812529.json
          -f data/records/authors/1004662.json
          -f data/records/authors/1060898.json
          -f data/records/authors/1013725.json
          -f data/records/authors/1078577.json
          -f data/records/authors/1064002.json
          -f data/records/authors/1306569.json
          -f data/records/conferences/1787117.json
          -f data/records/literature/1787272.json
          -f data/records/seminars/1799778.json
          -f data/records/conferences/1217045.json
          -f data/records/jobs/1812440.json
          -f data/records/authors/1274753.json
          -f data/records/institutions/902858.json
          -f data/records/experiments/1513946.json
          -f data/records/literature/1331798.json
          -f data/records/literature/1325985.json
          -f data/records/literature/1306493.json
          -f data/records/literature/1264675.json
          -f data/records/literature/1263659.json
          -f data/records/literature/1263207.json
          -f data/records/literature/1249881.json
          -f data/records/literature/1235543.json
          -f data/records/literature/1198168.json
          -f data/records/literature/1113908.json
          -f data/records/literature/873915.json
          -f data/records/literature/1688995.json
          -f data/records/literature/1290484.json
          -f data/records/literature/1264013.json
          -f data/records/literature/1257993.json
          -f data/records/literature/1310649.json
          -f data/records/literature/1473056.json
          -f data/records/literature/1358394.json
          -f data/records/literature/1374620.json
          -f data/records/literature/1452707.json
          -f data/records/literature/1649231.json
          -f data/records/literature/1297062.json
          -f data/records/literature/1313615.json
          -f data/records/literature/1597429.json
          -f data/records/literature/1184194.json
          -f data/records/literature/1322719.json
          -f data/records/literature/1515024.json
          -f data/records/literature/1510263.json
          -f data/records/literature/1415120.json
          -f data/records/literature/1400808.json
          -f data/records/literature/1420712.json
          -f data/records/literature/1492108.json
          -f data/records/literature/1598135.json
          -f data/records/literature/1306493.json
          -f data/records/literature/1383683.json
          -f data/records/literature/1238110.json
          -f data/records/literature/44707.json
          -f data/records/journals/1213103.json
          -f data/records/journals/1213100.json

      - name: cypress
        uses: cypress-io/github-action@v5
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
        with:
          working-directory: ./e2e
          record: true
          parallel: true
          browser: ${{ matrix.browser }}
          tag: Chrome
          env: inspirehep_url=http://localhost:8080

      - name: application logs
        run: |
          for container in (hep-worker hep-web next-worker next-web record-editor ui); do
            echo "::group::$container"
            docker logs $container
            echo "::endgroup::"
          done
